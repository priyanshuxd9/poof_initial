
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // User Profile Avatars: Only the user can update their own avatar.
    match /user-avatars/{userId}/avatar.jpg {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Group Avatars: Only the group owner can update the group's icon.
    match /group-avatars/{groupId}/avatar.jpg {
      allow read: if true;
      allow write: if request.auth != null
                   && exists(/databases/(default)/documents/groups/$(groupId))
                   && get(/databases/(default)/documents/groups/$(groupId)).data.ownerId == request.auth.uid;
    }

    // Group Media (images/videos in chat): Only group members can read/write.
    match /group-media/{groupId}/{allPaths=**} {
      allow read, write: if request.auth != null
                         && exists(/databases/(default)/documents/groups/$(groupId))
                         // Ensure the user is a member of the group.
                         && request.auth.uid in get(/databases/(default)/documents/groups/$(groupId)).data.memberUserIds
                         // Enforce a 30MB file size limit.
                         && request.resource.size < 30 * 1024 * 1024;
    }
  }
}
