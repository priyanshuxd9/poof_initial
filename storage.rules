rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // User Avatars: Allow users to read/write their own avatar.
    match /user-avatars/{userId}/avatar.jpg {
      allow read;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Group Avatars:
    match /group-avatars/{groupId}/avatar.jpg {
      // Anyone can read group avatars.
      allow read;

      // Allow write if:
      // 1. The user is authenticated, and the group document doesn't exist yet (for creation).
      // OR
      // 2. The user is the owner of the existing group (for updates).
      allow write: if request.auth != null &&
        (!exists(/databases/$(database)/documents/groups/$(groupId)) ||
          get(/databases/$(database)/documents/groups/$(groupId)).data.ownerId == request.auth.uid);
    }
  }
}