
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
  
    // Helper function to check if a user is a member of a specific group by looking up the group document in Firestore.
    function isGroupMember(groupId) {
      return request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.memberUserIds;
    }

    // --- User Profile Pictures ---
    // A user can only read and write to their own avatar folder.
    match /user-avatars/{userId}/{allPaths=**} {
      allow read;
      allow write: if request.auth.uid == userId;
    }

    // --- Group Icons ---
    // Only the group owner can write a new group icon.
    // Any authenticated user can read group icons.
    match /group-avatars/{groupId}/{allPaths=**} {
      allow read;
      allow write: if get(/databases/$(database)/documents/groups/$(groupId)).data.ownerId == request.auth.uid;
    }

    // --- Group Media (Photos/Videos) ---
    // A user can read/write to a group's media folder ONLY if they are a member of that group.
    // Also enforce a file size limit of 30MB for uploads.
    match /group-media/{groupId}/{allPaths=**} {
      allow read: if isGroupMember(groupId);
      allow write: if isGroupMember(groupId) && request.resource.size < 30 * 1024 * 1024;
    }
  }
}
